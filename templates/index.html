<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Verification Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .form-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input.mismatch {
            border-color: #d63031;
            box-shadow: 0 0 0 2px rgba(214, 48, 49, 0.2);
        }
        input.verified {
            border-color: #00b894;
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
        }
        .document-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert {
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            display: none;
        }
        .alert-error {
            background-color: #ffe6e6;
            color: #d63031;
            border: 1px solid #fab1a0;
        }
        .alert-success {
            background-color: #e6ffe6;
            color: #00b894;
            border: 1px solid #55efc4;
        }
        button {
            background-color: #0984e3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0873c4;
        }
        .hidden {
            display: none;
        }
        .field-hint {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .modal-buttons button {
            margin-left: 10px;
        }
        .modal-buttons .cancel-btn {
            background-color: #95a5a6;
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Document Verification Form</h1>
        <form id="verificationForm">
            <div class="form-group">
                <label for="name">Full Name:</label>
                <input type="text" id="name" name="name" required>
                <div id="nameAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="dob">Date of Birth:</label>
                <input type="date" id="dob" name="dob" required>
                <div id="dobAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
                <div id="genderAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="aadhar">Aadhar Number:</label>
                <input type="text" id="aadhar" name="aadhar" required>
                <div id="aadharAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="pan">PAN Number:</label>
                <input type="text" id="pan" name="pan" required>
                <div id="panAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="semester">Semester:</label>
                <select id="semester" name="semester" required>
                    <option value="">Select Semester</option>
                    <option value="First">First</option>
                    <option value="Second">Second</option>
                    <option value="Third">Third</option>
                    <option value="Fourth">Fourth</option>
                    <option value="Fifth">Fifth</option>
                    <option value="Sixth">Sixth</option>
                    <option value="Seventh">Seventh</option>
                    <option value="Eighth">Eighth</option>
                </select>
                <div id="semesterAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="rollNumber">Roll Number:</label>
                <input type="text" id="rollNumber" name="rollNumber" required>
                <div id="rollNumberAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="cgpa">CGPA:</label>
                <input type="number" id="cgpa" name="cgpa" step="0.01" required>
                <div id="cgpaAlert" class="alert"></div>
            </div>

            <div class="form-group">
                <label for="sgpa">SGPA:</label>
                <input type="number" id="sgpa" name="sgpa" step="0.01" required>
                <div id="sgpaAlert" class="alert"></div>
            </div>

            <div class="document-section">
                <h3>Aadhar Card</h3>
                <input type="file" id="aadharDoc" accept="image/*" required>
                <div id="aadharDocAlert" class="alert"></div>
            </div>

            <div class="document-section">
                <h3>PAN Card</h3>
                <input type="file" id="panDoc" accept="image/*" required>
                <div id="panDocAlert" class="alert"></div>
            </div>

            <div class="document-section">
                <h3>Marksheet</h3>
                <input type="file" id="marksheetDoc" accept="image/*" required>
                <div id="marksheetDocAlert" class="alert"></div>
            </div>

            <button type="submit">Submit</button>
        </form>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h2>Confirm Submission</h2>
            <p>There are mismatched fields in your form. Do you want to submit anyway?</p>
            <div class="modal-buttons">
                <button id="cancelSubmit" class="cancel-btn">Cancel</button>
                <button id="confirmSubmit">Submit Anyway</button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('verificationForm');
        const documentInputs = {
            aadhar: document.getElementById('aadharDoc'),
            pan: document.getElementById('panDoc'),
            marksheet: document.getElementById('marksheetDoc')
        };

        // Track validation state for each field
        const validationState = {};
        
        // Store document data for revalidation
        const documentData = {
            aadhar: null,
            pan: null,
            marksheet: null
        };

        function showAlert(elementId, message, isError = true) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.style.display = 'block';
            alert.className = `alert ${isError ? 'alert-error' : 'alert-success'}`;
        }

        function hideAlert(elementId) {
            const alert = document.getElementById(elementId);
            alert.style.display = 'none';
        }

        function updateFieldStyle(fieldId, isValid, value = null) {
            const field = document.getElementById(fieldId);
            field.classList.remove('mismatch', 'verified');
            
            if (isValid) {
                field.classList.add('verified');
                validationState[fieldId] = true;
            } else {
                field.classList.add('mismatch');
                validationState[fieldId] = false;
            }
        }

        function revalidateField(fieldId, docType) {
            if (!documentData[docType]) return;
            
            const field = document.getElementById(fieldId);
            const fieldValue = field.value;
            const docValue = documentData[docType][fieldId];
            
            if (!fieldValue || !docValue) return;
            
            // Special handling for Aadhar number (ignore spaces)
            if (fieldId === 'aadhar') {
                const normalizedFieldValue = fieldValue.replace(/\s+/g, '');
                const normalizedDocValue = docValue.replace(/\s+/g, '');
                
                if (normalizedFieldValue.toLowerCase() === normalizedDocValue.toLowerCase()) {
                    showAlert(`${fieldId}Alert`, 'Document verification successful', false);
                    updateFieldStyle(fieldId, true);
                } else {
                    showAlert(`${fieldId}Alert`, 
                        `Mismatch found: Form value "${fieldValue}" doesn't match document value "${docValue}"`);
                    updateFieldStyle(fieldId, false);
                }
            } 
            // Special handling for CGPA/SGPA (allow small differences)
            else if (fieldId === 'cgpa' || fieldId === 'sgpa') {
                const fieldFloat = parseFloat(fieldValue);
                const docFloat = parseFloat(docValue);
                
                if (!isNaN(fieldFloat) && !isNaN(docFloat) && Math.abs(fieldFloat - docFloat) < 0.01) {
                    showAlert(`${fieldId}Alert`, 'Document verification successful', false);
                    updateFieldStyle(fieldId, true);
                } else {
                    showAlert(`${fieldId}Alert`, 
                        `Mismatch found: Form value "${fieldValue}" doesn't match document value "${docValue}"`);
                    updateFieldStyle(fieldId, false);
                }
            }
            // Default comparison for other fields
            else {
                if (fieldValue.toLowerCase().trim() === docValue.toLowerCase().trim()) {
                    showAlert(`${fieldId}Alert`, 'Document verification successful', false);
                    updateFieldStyle(fieldId, true);
                } else {
                    showAlert(`${fieldId}Alert`, 
                        `Mismatch found: Form value "${fieldValue}" doesn't match document value "${docValue}"`);
                    updateFieldStyle(fieldId, false);
                }
            }
        }

        async function validateDocument(file, type) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', type);

            // Add all form fields to the request
            const formFields = ['name', 'dob', 'gender', 'aadhar', 'pan', 'semester', 'rollNumber', 'cgpa', 'sgpa'];
            formFields.forEach(field => {
                const input = document.getElementById(field);
                if (input) {
                    formData.append(field, input.value);
                }
            });

            try {
                const response = await fetch('/validate-document', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                // Store document data for revalidation
                if (data.docData) {
                    documentData[type] = data.docData;
                }
                
                if (data.mismatches && data.mismatches.length > 0) {
                    data.mismatches.forEach(mismatch => {
                        const fieldId = mismatch.field;
                        showAlert(`${fieldId}Alert`, 
                            `Mismatch found: Form value "${mismatch.formValue}" doesn't match document value "${mismatch.docValue}"`);
                        updateFieldStyle(fieldId, false);
                    });
                }
                
                if (data.validatedFields && data.validatedFields.length > 0) {
                    data.validatedFields.forEach(field => {
                        showAlert(`${field}Alert`, 'Document verification successful', false);
                        updateFieldStyle(field, true);
                    });
                }
            } catch (error) {
                console.error('Error validating document:', error);
                showAlert(`${type}DocAlert`, 'Error validating document. Please try again.');
            }
        }

        // Add event listeners for document uploads
        Object.entries(documentInputs).forEach(([type, input]) => {
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    validateDocument(e.target.files[0], type);
                }
            });
        });

        // Add event listeners for field changes
        const formFields = ['name', 'dob', 'gender', 'aadhar', 'pan', 'semester', 'rollNumber', 'cgpa', 'sgpa'];
        formFields.forEach(field => {
            const input = document.getElementById(field);
            if (input) {
                input.addEventListener('input', () => {
                    // Determine which document type to check against
                    let docType = null;
                    if (['name', 'dob', 'gender', 'aadhar'].includes(field)) {
                        docType = 'aadhar';
                    } else if (['name', 'pan'].includes(field)) {
                        docType = 'pan';
                    } else if (['semester', 'rollNumber', 'cgpa', 'sgpa'].includes(field)) {
                        docType = 'marksheet';
                    }
                    
                    if (docType && documentData[docType]) {
                        revalidateField(field, docType);
                    }
                });
            }
        });

        // Modal handling
        const modal = document.getElementById('confirmationModal');
        const cancelBtn = document.getElementById('cancelSubmit');
        const confirmBtn = document.getElementById('confirmSubmit');
        
        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        confirmBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            submitFormData();
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check if all fields are validated
            const hasUnvalidatedFields = Object.values(validationState).some(isValid => !isValid);
            if (hasUnvalidatedFields) {
                // Show confirmation modal
                modal.style.display = 'block';
            } else {
                submitFormData();
            }
        });
        
        async function submitFormData() {
            const formData = new FormData(form);
            // Add hasMismatches flag if there are unvalidated fields
            const hasUnvalidatedFields = Object.values(validationState).some(isValid => !isValid);
            formData.append('hasMismatches', hasUnvalidatedFields.toString());
            
            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Form submitted successfully!');
                } else {
                    alert('Form submission failed. Please check all fields and try again.');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('Error submitting form. Please try again.');
            }
        }
    </script>
</body>
</html>